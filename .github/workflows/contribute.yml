name: Contribute Redhat forks

on:
  schedule:
    - cron: '0 */3 * * *'  # Every 3 hours
  workflow_dispatch: {}     # Manual trigger

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  contribute:
    runs-on: ubuntu-latest
    timeout-minutes: 75

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Install ralph-loop plugin
        run: |
          claude plugin marketplace add anthropics/claude-plugins-official
          claude plugin install ralph-loop@claude-plugins-official

      - name: Set up GCP credentials
        run: |
          echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}' > /tmp/gcp-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-credentials.json" >> $GITHUB_ENV

      - name: Import GPG key and configure git
        env:
          GITHUB_TOKEN: ${{ secrets.PROFILE_HOOK }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          # Import GPG private key
          echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --import
          # Trust the key ultimately (requires full fingerprint)
          GPG_FINGERPRINT=$(gpg --list-keys --with-colons "${{ secrets.GPG_KEY_ID }}" | awk -F: '/^fpr:/{print $10; exit}')
          echo "${GPG_FINGERPRINT}:6:" | gpg --import-ownertrust
          # Configure GPG for non-interactive use in CI
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          gpgconf --kill gpg-agent
          # Configure git identity and signing
          git config --global user.name "David O Neill"
          git config --global user.email "dmz.oneill@gmail.com"
          git config --global user.signingkey "${{ secrets.GPG_KEY_ID }}"
          git config --global commit.gpgsign true
          git config --global tag.gpgsign true
          # Use gh as git credential helper so HTTPS cloning/pushing works with GITHUB_TOKEN
          gh auth setup-git

      - name: Create stream filter
        run: |
          python3 -c "
          import sys, os
          script = '''import sys, json

          for line in sys.stdin:
              line = line.strip()
              if not line:
                  continue
              try:
                  event = json.loads(line)
              except json.JSONDecodeError:
                  print(line, flush=True)
                  continue
              t = event.get('type', '')
              if t == 'assistant':
                  for block in event.get('message', {}).get('content', []):
                      if block.get('type') == 'text':
                          text = block.get('text', '').strip()
                          if text:
                              for tl in text.split(chr(10)):
                                  print('[text] ' + tl[:300], flush=True)
                      elif block.get('type') == 'tool_use':
                          name = block.get('name', '?')
                          inp = block.get('input', {})
                          if name == 'Bash':
                              desc = inp.get('description', '')
                              cmd = inp.get('command', '')
                              label = desc if desc else cmd[:120]
                              print('[tool] Bash: ' + label, flush=True)
                          elif name == 'Task':
                              desc = inp.get('description', str(inp.get('prompt', ''))[:80])
                              print('[tool] Task: ' + desc, flush=True)
                          elif name in ('Read', 'Write', 'Edit'):
                              print('[tool] ' + name + ': ' + inp.get('file_path', '?'), flush=True)
                          elif name in ('Grep', 'Glob'):
                              print('[tool] ' + name + ': ' + inp.get('pattern', '?'), flush=True)
                          else:
                              print('[tool] ' + name, flush=True)
              elif t == 'result':
                  result = event.get('result', '')
                  cost = event.get('cost_usd', 0)
                  turns = event.get('num_turns', 0)
                  print('[done] turns=' + str(turns) + ' cost=\$' + f'{cost:.4f}', flush=True)
                  if result:
                      for rl in result.strip().split(chr(10))[:5]:
                          print('  ' + rl[:200], flush=True)
          '''
          with open('/tmp/stream-filter.py', 'w') as f:
              f.write(script)
          "

      - name: Run contributor swarm
        env:
          CLAUDE_CODE_USE_VERTEX: ${{ secrets.CLAUDE_CODE_USE_VERTEX }}
          ANTHROPIC_VERTEX_PROJECT_ID: ${{ secrets.ANTHROPIC_VERTEX_PROJECT_ID }}
          CLOUD_ML_REGION: ${{ secrets.CLOUD_ML_REGION }}
          GITHUB_TOKEN: ${{ secrets.PROFILE_HOOK }}
        run: |
          PROMPT="/swarm"

          # --- Background state commit loop ---
          STATE_FILE=".claude/.swarm-state.json"
          COMMIT_INTERVAL=300
          STATE_HASH=""
          (
            sleep 60
            while true; do
              sleep $COMMIT_INTERVAL
              if [ -f "$STATE_FILE" ] && python3 -c "import json; json.load(open('$STATE_FILE'))" 2>/dev/null; then
                NEW_HASH=$(sha256sum "$STATE_FILE" | cut -d' ' -f1)
                if [ "$NEW_HASH" != "$STATE_HASH" ]; then
                  STATE_HASH="$NEW_HASH"
                  git add -f "$STATE_FILE" 2>/dev/null || continue
                  git diff --cached --quiet && continue
                  git commit --no-gpg-sign -m "chore: periodic state checkpoint" 2>/dev/null || continue
                  git pull --rebase 2>/dev/null || true
                  git push 2>/dev/null || true
                  echo "--- [state committed and pushed] ---"
                fi
              fi
            done
          ) &
          COMMIT_PID=$!

          # --- Run claude with stream-json output ---
          touch /tmp/claude-raw.log
          START_TIME=$(date +%s)

          timeout --signal=TERM --kill-after=60 3600 \
            claude -p \
              --dangerously-skip-permissions \
              --output-format stream-json \
              --verbose \
              --max-turns 200 \
              "$PROMPT" 2>&1 \
            | tee /tmp/claude-raw.log \
            | python3 /tmp/stream-filter.py \
            || true

          ELAPSED=$(( $(date +%s) - START_TIME ))
          echo "=== Process finished after $((ELAPSED / 60))m $((ELAPSED % 60))s ==="

          kill $COMMIT_PID 2>/dev/null || true

      - name: Show summary
        if: always()
        run: |
          echo "=== Claude Raw Output (last 200 lines) ==="
          tail -200 /tmp/claude-raw.log 2>/dev/null || echo "No output log found"

      - name: Cleanup credentials
        if: always()
        run: rm -f /tmp/gcp-credentials.json

      - name: Final state commit
        if: always()
        run: |
          # Pull in case the background loop pushed commits ahead of us
          git pull --rebase 2>/dev/null || true
          git add -f .claude/.swarm-state.json 2>/dev/null || true
          git diff --cached --quiet || git commit --no-gpg-sign -m "chore: final state update after contributor run"
          git push || true
