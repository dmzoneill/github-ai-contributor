name: Contribute my forks

on:
  schedule:
    - cron: '30 1,4,7,10,13,16,19,22 * * *'  # Every 3 hours, offset 1.5h from Redhat
  workflow_dispatch: {}     # Manual trigger

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  contribute:
    runs-on: ubuntu-latest
    timeout-minutes: 75

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Install ralph-loop plugin
        run: |
          claude plugin marketplace add anthropics/claude-plugins-official
          claude plugin install ralph-loop@claude-plugins-official

      - name: Set up GCP credentials
        run: |
          echo '${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}' > /tmp/gcp-credentials.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-credentials.json" >> $GITHUB_ENV

      - name: Configure git
        env:
          GITHUB_TOKEN: ${{ secrets.PROFILE_HOOK }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          gh auth setup-git

      - name: Create stream filter
        run: |
          python3 -c "
          import sys, os
          script = '''import sys, json

          for line in sys.stdin:
              line = line.strip()
              if not line:
                  continue
              try:
                  event = json.loads(line)
              except json.JSONDecodeError:
                  print(line, flush=True)
                  continue
              t = event.get('type', '')
              if t == 'assistant':
                  for block in event.get('message', {}).get('content', []):
                      if block.get('type') == 'text':
                          text = block.get('text', '').strip()
                          if text:
                              for tl in text.split(chr(10)):
                                  print('[text] ' + tl[:300], flush=True)
                      elif block.get('type') == 'tool_use':
                          name = block.get('name', '?')
                          inp = block.get('input', {})
                          if name == 'Bash':
                              desc = inp.get('description', '')
                              cmd = inp.get('command', '')
                              label = desc if desc else cmd[:120]
                              print('[tool] Bash: ' + label, flush=True)
                          elif name == 'Task':
                              desc = inp.get('description', str(inp.get('prompt', ''))[:80])
                              print('[tool] Task: ' + desc, flush=True)
                          elif name in ('Read', 'Write', 'Edit'):
                              print('[tool] ' + name + ': ' + inp.get('file_path', '?'), flush=True)
                          elif name in ('Grep', 'Glob'):
                              print('[tool] ' + name + ': ' + inp.get('pattern', '?'), flush=True)
                          else:
                              print('[tool] ' + name, flush=True)
              elif t == 'result':
                  result = event.get('result', '')
                  cost = event.get('cost_usd', 0)
                  turns = event.get('num_turns', 0)
                  print('[done] turns=' + str(turns) + ' cost=\$' + f'{cost:.4f}', flush=True)
                  if result:
                      for rl in result.strip().split(chr(10))[:5]:
                          print('  ' + rl[:200], flush=True)
          '''
          with open('/tmp/stream-filter.py', 'w') as f:
              f.write(script)
          "

      - name: Run contributor swarm
        env:
          CLAUDE_CODE_USE_VERTEX: ${{ secrets.CLAUDE_CODE_USE_VERTEX }}
          ANTHROPIC_VERTEX_PROJECT_ID: ${{ secrets.ANTHROPIC_VERTEX_PROJECT_ID }}
          CLOUD_ML_REGION: ${{ secrets.CLOUD_ML_REGION }}
          GITHUB_TOKEN: ${{ secrets.PROFILE_HOOK }}
        run: |
          PROMPT="You are the contributor swarm orchestrator for github-ai-contributor. You MUST use tools to do real work. Do NOT just output text. TARGET ORG: dmzoneill-forks

          STEP 1: Run this command to check rate limit:
            gh api rate_limit --jq .rate.remaining
          If remaining < 500, stop immediately and report.

          STEP 2: Run this command to read the swarm state:
            cat .claude/.swarm-state.json 2>/dev/null || echo {}

          STEP 3: List all repos in target org and RANDOMIZE the order:
            gh repo list dmzoneill-forks --limit 200 --json name,url -q .[].name | shuf

          STEP 4: For each fork (in the randomized order), identify the upstream (parent) repo:
            gh api repos/{org}/{repo} --jq .parent.full_name

          STEP 5: Rebase all forks from their upstream repos to keep them current.

          STEP 5.5: ALWAYS check existing open PRs and issues we have per upstream repo BEFORE doing any work:
            - Count our open PRs per upstream repo. Max 3 open PRs per repo. Do NOT create more if at limit.
            - Count our open issues (feature suggestions) per upstream repo. Max 1 open issue per repo. Do NOT create more if at limit.
            Skip repos that are already at their limits.

          STEP 6: Scan upstream repos for open issues. Skip issues we created ourselves.
          For each issue, assess confidence we can fix it (>= 90% threshold).
          Balance work across repos - max 3 open PRs per upstream repo.

          STEP 7: For fixable issues:
          - Create branch from upstream default branch (NOT origin): fix/issue-{number}-{short-description}
          - Implement the fix
          - Run available tests/linters
          - Commit with commitlint-valid conventional message
          - Push branch to fork
          - Create PR from fork to upstream

          STEP 8: Check our existing open PRs for:
          - Reviewer comments needing response
          - CI/pipeline failures needing fixes
          - Merge conflicts needing rebase

          STEP 9: Suggest at least 1 feature per repo (as issue on upstream) if not already done.

          STEP 10: Write results to .claude/.swarm-state.json

          STEP 11: Output a summary of all actions taken.

          IMPORTANT: You must actually run commands and do work. Do not skip steps."

          # --- Background state commit loop ---
          STATE_FILE=".claude/.swarm-state.json"
          COMMIT_INTERVAL=300
          STATE_HASH=""
          (
            sleep 60
            while true; do
              sleep $COMMIT_INTERVAL
              if [ -f "$STATE_FILE" ] && python3 -c "import json; json.load(open('$STATE_FILE'))" 2>/dev/null; then
                NEW_HASH=$(sha256sum "$STATE_FILE" | cut -d' ' -f1)
                if [ "$NEW_HASH" != "$STATE_HASH" ]; then
                  STATE_HASH="$NEW_HASH"
                  git add -f "$STATE_FILE" 2>/dev/null || continue
                  git diff --cached --quiet && continue
                  git commit -m "chore: periodic state checkpoint" 2>/dev/null || continue
                  git pull --rebase 2>/dev/null || true
                  git push 2>/dev/null || true
                  echo "--- [state committed and pushed] ---"
                fi
              fi
            done
          ) &
          COMMIT_PID=$!

          # --- Run claude with stream-json output ---
          touch /tmp/claude-raw.log
          START_TIME=$(date +%s)

          timeout --signal=TERM --kill-after=60 3600 \
            claude -p \
              --dangerously-skip-permissions \
              --output-format stream-json \
              --verbose \
              --max-turns 200 \
              "$PROMPT" 2>&1 \
            | tee /tmp/claude-raw.log \
            | python3 /tmp/stream-filter.py \
            || true

          ELAPSED=$(( $(date +%s) - START_TIME ))
          echo "=== Process finished after $((ELAPSED / 60))m $((ELAPSED % 60))s ==="

          kill $COMMIT_PID 2>/dev/null || true

      - name: Show summary
        if: always()
        run: |
          echo "=== Claude Raw Output (last 200 lines) ==="
          tail -200 /tmp/claude-raw.log 2>/dev/null || echo "No output log found"

      - name: Cleanup credentials
        if: always()
        run: rm -f /tmp/gcp-credentials.json

      - name: Final state commit
        if: always()
        run: |
          git pull --rebase 2>/dev/null || true
          git add -f .claude/.swarm-state.json 2>/dev/null || true
          git diff --cached --quiet || git commit -m "chore: final state update after dmz contributor run"
          git push || true
